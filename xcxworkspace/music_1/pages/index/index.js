// index.js
// 获取应用实例
const app = getApp()

Page({
  data: {
    item:0,
    tab:0,
    //播放列表数据
    playlist:[{
      id:"1",
      title:"春天里",
      singer:"汪峰",
      src:"http://ws.stream.qqmusic.qq.com/C400001vBIsm2lIOej.m4a?guid=261408680&vkey=65A0874085C1A17E10FEADE34A4295FD2355B1EC19BD6C9C42A36F21AB130372FA7836D94B9E79328908AAAD02B756FAA46D8A42C81CDF90&uin=&fromtag=120002",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20150718/20150718090236835587.jpg"
    },
    {
      id:"2",
      title:"虹之间",
      singer:"金贵晟",
      src:"http://music.163.com/song/media/outer/url?id=28219176.mp3",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20160907/20160907185557918076.jpg"
    },
    {
      id:"3",
      title:"断桥残血",
      singer:"许嵩",
      src:"http://music.163.com/song/media/outer/url?id=167937.mp3",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20190924/20190924195702432753.jpg"
    },
    {
      id:"4",
      title:"曹操",
      singer:"林俊杰",
      src:"http://ws.stream.qqmusic.qq.com/C400000wHNEJ2vUo1O.m4a?guid=689308476&vkey=70E770624239A4689500A3B4C182AE6257969F24AE4DB0B441727C011120DAE6C56435FFEB77B35665C4E361719AD8238879FC9BFFD11D16&uin=&fromtag=120002",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20200909/20200909141223824871.jpg"
    },
    {
      id:"5",
      title:"哥只是个传说",
      singer:"陈旭",
      src:"http://music.163.com/song/media/outer/url?id=69611.mp3",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20191011/20191011165810391053.jpg"
    },
    {
      id:"6",
      title:"不要说话",
      singer:"陈奕迅",
      src:"http://music.163.com/song/media/outer/url?id=25906124.mp3",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20160908/20160908035159476194.jpg"
    },
    {
      id:"7",
      title:"再飞行",
      singer:"逃跑计划",
      src:"http://music.163.com/song/media/outer/url?id=28267530.mp3",
      coverImgUrl:"https://tse4-mm.cn.bing.net/th/id/OIP-C.eR-CRE6KJ6h25dnMBnvwxQHaEo?pid=ImgDet&rs=1"
    },
    {
      id:"8",
      title:"小酒窝",
      singer:"林俊杰",
      src:"http://ws.stream.qqmusic.qq.com/C400004gaUdP3lE49S.m4a?guid=284199567&vkey=0DFE26BB675F1FC4697D1B78AEDBC0CF9DF0B231E53409685FD84562313C274962797B3AAF0E3AE72B6D62254BE87E1906AA29EE3B4F7C40&uin=&fromtag=120002",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20150718/20150718065653668323.jpg"
    },
    {
      id:"9",
      title:"铁甲威虫",
      singer:"刘罡",
      src:"http://music.163.com/song/media/outer/url?id=27901942.mp3",
      coverImgUrl:"https://imgessl.kugou.com/uploadpic/softhead/400/20211126/20211126111537266170.jpg"
    },
    {
      id:"10",
      title:"你从未离去",
      singer:"白挺",
      src:"http://music.163.com/song/media/outer/url?id=31365604.mp3",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20220210/20220210091901693720.jpg"
    },
    {
      id:"11",
      title:"人生不过是一百年",
      singer:"袁接伟",
      src:"http://ws.stream.qqmusic.qq.com/C400002OoPnD2lB4mm.m4a?guid=312639775&vkey=E377373503E159CA2A1B7A314A35330BBD14C4BADCFBEA931296FB2077B11B8FF4CAB26CD19A58C3308C1985C9603DC7B69FC5C0C5216C29&uin=&fromtag=120002",
      coverImgUrl:"https://tse2-mm.cn.bing.net/th/id/OIP-C.v84HAU2aN5xNksLHCRymwgHaFj?pid=ImgDet&rs=1"
    },
    {
      id:"12",
      title:"别看我是一只羊",
      singer:"古倩敏/杨沛宜",
      src:"http://music.163.com/song/media/outer/url?id=5242612.mp3",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20220309/20220309175504734162.jpg"
    },
    {
      id:"13",
      title:"梦的光点",
      singer:"王心凌",
      src:"http://music.163.com/song/media/outer/url?id=1808293217.mp3",
      coverImgUrl:"https://tse1-mm.cn.bing.net/th/id/R-C.3067521d69732ccfbfba99ad266c83cf?rik=sbS%2bc%2fSQpweTJA&riu=http%3a%2f%2fpic.baike.soso.com%2fugc%2fbaikepic2%2f31177%2f20161203172439-372631332.jpg%2f0&ehk=PayYgUsl6FzjZgNfzxA6eIulIVEMvvNv8pLDdVH100Q%3d&risl=&pid=ImgRaw&r=0"
    },
    {
      id:"14",
      title:"疯狂果宝",
      singer:"陈洁丽等",
      src:"http://music.163.com/song/media/outer/url?id=27906420.mp3",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20220322/20220322180411544668.jpg"
    },
    {
      id:"15",
      title:"十二生肖闯江湖",
      singer:"十二生肖",
      src:"http://music.163.com/song/media/outer/url?id=27908110.mp3",
      coverImgUrl:"https://imgessl.kugou.com/uploadpic/softhead/400/20160509/20160509085816774290.jpg"
    },
    {
      id:"16",
      title:"爱情公寓",
      singer:"爱情公寓全体住户",
      src:"http://music.163.com/song/media/outer/url?id=25639006.mp3",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20200928/20200928021448706222.jpg"
    },
    {
      id:"17",
      title:"时间都去哪了",
      singer:"王铮亮",
      src:"http://music.163.com/song/media/outer/url?id=1854387200.mp3",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20150718/20150718143125208700.jpg"
    },
    {
      id:"18",
      title:"逆战",
      singer:"张杰",
      src:"http://music.163.com/song/media/outer/url?id=28996036.mp3",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20200723/20200723101711174460.jpg"
    },
    {
      id:"19",
      title:"此生不换",
      singer:"青鸟飞鱼",
      src:"http://music.163.com/song/media/outer/url?id=25638340.mp3",
      coverImgUrl:"https://imgessl.kugou.com/stdmusic/20200909/20200909123219737311.jpg"
    }
  ],
    //记录播放信息
    state:"paused",//播放状态
    playIndex:0,//音乐索引
    play:{
      currentTime:'00:00',//播放时长
      duration:'00:00',//总时长
      percent:0,//播放进度
      title:'',//音乐标题
      singer:'',//艺术家
      coverImgUrl:''//专辑封面图片
    }
  },
  changeItem:function(e){
    this.setData({
      item:e.target.dataset.item
    });
  },
  changeTab:function(e){
    this.setData({
      tab:e.detail.current
    });
  },
  //实现播放器功能
  audioCtx:null,//音乐实例
  onReady:function(){
    this.audioCtx=wx.createInnerAudioContext()
    //默认选择第一曲
    this.setMusic(0)
    var that=this
    //播放失败检测
    this.audioCtx.onError(function(){
      console.log('播放失败：'+that.audioCtx.src)
    })
    //播放完自动换下一曲
    this.audioCtx.onEnded(function(){
      that.next()
    })
    //自动更新播放进度
    this.audioCtx.onPlay(function(){})
    this.audioCtx.onTimeUpdate(function(){
      that.setData({
        'play.duration':formatTime(that.audioCtx.duration),
        'play.currentTime':formatTime(that.audioCtx.currentTime),
        'play.percent':that.audioCtx.currentTime / that.audioCtx.duration * 100
      })
    })
    this.audioCtx.onCanplay(function(){//音频就绪后
      //访问下音频的属性，解决切换曲目或者使用seek()调整进度后onTimeUpdate事件失效问题
      that.audioCtx.currentTime
    })
    //格式化时间
    function formatTime(time){
      var minute=Math.floor(time/60)%60;
      var second=Math.floor(time)%60
      return (minute < 10 ? '0' +minute : minute)+':'+(second <10 ? '0' +second:second)
    }
  },
  //音乐播放
  setMusic:function(index){
    var music=this.data.playlist[index]
    this.audioCtx.src=music.src
    this.setData({
      playIndex:index,
      'play.title':music.title,
      'play.singer':music.singer,
      'play.coverImgUrl':music.coverImgUrl,
      'play.currentTime':'00:00',
      'play.duration':'00:00',
      'play.percent':0
    })
  },
  //播放按钮
  play:function(){
    this.audioCtx.play()
    this.setData({
      state:'running'
    })
  },
  //暂停按钮
  pause:function(){
    this.audioCtx.pause()
    this.setData({
      state:'paused'
    })
  },
  //下一首按钮
  next:function(){
    var index=this.data.playIndex >= this.data.playlist.length - 1 ? 0 : this.data.playIndex +1
    this.setMusic(index)
    if(this.data.state ==='running'){
      this.play()
    }
  },
  //上一首按钮
  preceding:function(){
    var index=this.data.playIndex > this.data.playlist.length - 1 ? 0 : this.data.playIndex -1
    this.setMusic(index)
    if(this.data.state ==='running'){
      this.play()
    }
  },
  //滚动条调节歌曲进度
  sliderChange:function(e){
    var second=e.detail.value * this.audioCtx.duration / 100
    this.audioCtx.seek(second)
  },
  //播放列表换曲功能
  change:function(e){
    this.setMusic(e.currentTarget.dataset.index)
    this.play()
  },
})
